name: Vintage Clothing Monitor

on:
  schedule:
    # Run every 2 hours (cron format: minute hour day month weekday)
    # UTC timezone - adjust times as needed
    - cron: '0 */2 * * *'
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          chromium-browser \
          chromium-chromedriver \
          xvfb \
          libnss3 \
          libatk-bridge2.0-0 \
          libdrm2 \
          libxkbcommon0 \
          libxcomposite1 \
          libxdamage1 \
          libxfixes3 \
          libxrandr2 \
          libgbm1 \
          libasound2t64
        # Ensure chromedriver is in PATH
        sudo ln -sf /usr/lib/chromium-browser/chromedriver /usr/local/bin/chromedriver || true
        # Verify Chrome and chromedriver are accessible
        chromium-browser --version || true
        chromedriver --version || true
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Set up environment variables
      env:
        RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
        RESEND_FROM_EMAIL: ${{ secrets.RESEND_FROM_EMAIL }}
        SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        SMTP_PORT: ${{ secrets.SMTP_PORT }}
        EMAIL_USER: ${{ secrets.EMAIL_USER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
      run: |
        # Create .env file from secrets
        cat > .env << EOF
        RESEND_API_KEY=${RESEND_API_KEY}
        RECIPIENT_EMAIL=${RECIPIENT_EMAIL}
        RESEND_FROM_EMAIL=${RESEND_FROM_EMAIL}
        SMTP_SERVER=${SMTP_SERVER}
        SMTP_PORT=${SMTP_PORT}
        EMAIL_USER=${EMAIL_USER}
        EMAIL_PASSWORD=${EMAIL_PASSWORD}
        HEADLESS=true
        EOF
    
    - name: Download previous database (if exists)
      uses: actions/download-artifact@v4
      with:
        name: database
        path: .
      continue-on-error: true
    
    - name: Run monitoring cycle
      env:
        DISPLAY: :99
        CHROME_BIN: /usr/bin/chromium-browser
        CHROMEDRIVER_PATH: /usr/bin/chromedriver
      run: |
        # Start virtual display for headless Chrome
        Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
        sleep 2  # Give Xvfb time to start
        # Run the monitoring script
        python run_once.py
      continue-on-error: true
    
    - name: Upload database (artifact)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: database
        path: champion_listings.db
        retention-days: 90
      continue-on-error: true
    
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs
        path: champion_monitor.log
        retention-days: 7
      continue-on-error: true

